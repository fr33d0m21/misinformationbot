<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MisinformationBot - No More Lies</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.1.1/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://d3js.org/d3.v6.min.js"></script>
    <style>
        body {
            background-color: #111;
            color: #0f0;
            font-family: 'Courier New', Courier, monospace;
            margin: 0;
            padding: 0;
            overflow: hidden;
        }

        .container {
            display: grid;
            grid-template-columns: 1fr 2fr;
            grid-gap: 20px;
            height: 100vh;
            padding: 20px;
        }

        #terminal {
            border: 3px solid #0f0;
            padding: 20px;
            background-color: #222;
            border-radius: 10px;
            overflow-y: auto;
            box-shadow: 0 0 20px #0f0;
        }

        #reports {
            background-color: #222;
            border: 3px solid #0f0;
            padding: 20px;
            border-radius: 10px;
            overflow-y: auto;
            box-shadow: 0 0 20px #0f0;
        }

        .line {
            margin-bottom: 10px;
            white-space: pre-wrap;
        }

        .user-input {
            color: #fff;
        }

        .bot-output {
            color: #0f0;
        }

        .thinking {
            color: #ff0;
        }

        #input-area {
            display: flex;
            margin-top: 20px;
        }

        #input-field {
            flex: 1;
            background-color: #333;
            color: #0f0;
            border: 1px solid #0f0;
            padding: 10px;
            border-radius: 5px 0 0 5px;
        }

        #send-button {
            background-color: #0f0;
            color: #111;
            border: none;
            padding: 10px 15px;
            border-radius: 0 5px 5px 0;
            cursor: pointer;
        }

        #send-button:hover {
            background-color: #0a0;
        }

        .report-section {
            margin-top: 20px;
            border: 1px solid #0f0;
            padding: 10px;
            background-color: #333;
        }

        .report-section h3 {
            color: #0f0;
            cursor: pointer;
        }

        .report-section .content {
            display: none;
            color: #0f0;
        }

        /* D3.js Timeline Styles */
        #timeline {
            width: 100%;
            height: 300px;
            margin-top: 20px;
        }

        .timeline-line {
            stroke: #0f0;
            stroke-width: 2px;
        }

        .timeline-circle {
            fill: #0f0;
            stroke: #111;
            stroke-width: 2px;
        }

        .timeline-label {
            font-size: 12px;
            fill: #0f0;
        }

        /* Add styles for better report presentation */
        .report-content {
            white-space: pre-wrap; /* Preserve line breaks and formatting from Markdown */
            font-family: 'Courier New', Courier, monospace;
        }

        .report-section h3 {
            color: #0f0;
            margin-top: 20px; /* Add spacing between sections */
            cursor: pointer;
        }

        .report-section .content {
            display: none;
            color: #0f0;
            border: 1px solid #0f0;
            padding: 10px;
            background-color: #333;
        }

        /* Mobile Responsiveness */
        @media (max-width: 768px) {
            .container {
                grid-template-columns: 1fr;
                grid-template-rows: auto auto;
            }
        }

        /* Follow-up Chat Box Styles */
        #followup-section {
            display: none; /* Initially hide the follow-up section */
        }

        #followup-chat {
            border: 1px solid #0f0;
            padding: 10px;
            background-color: #333;
            margin-top: 10px;
            overflow-y: auto;
            max-height: 200px;
        }

        #followup-input-area {
            display: flex;
            margin-top: 10px;
        }

        #followup-input-field {
            flex: 1;
            background-color: #333;
            color: #0f0;
            border: 1px solid #0f0;
            padding: 10px;
            border-radius: 5px 0 0 5px;
        }

        #followup-send-button {
            background-color: #0f0;
            color: #111;
            border: none;
            padding: 10px 15px;
            border-radius: 0 5px 5px 0;
            cursor: pointer;
        }

        #followup-send-button:hover {
            background-color: #0a0;
        }
    </style>
</head>
<body>
    <div class="container">
        <div id="terminal">
            <div class="line bot-output">
                <i class="fas fa-microchip"></i> MisinformationBot Activated. No more lies.
            </div>
            <div id="input-area">
                <input type="text" id="input-field" placeholder="Enter your claim here...">
                <button id="send-button">Send <i class="fas fa-paper-plane"></i></button>
            </div>
        </div>

        <div id="reports">
            <div id="followup-section"></div>
        </div>
    </div>

    <script>
        const terminal = document.getElementById("terminal");
        const reports = document.getElementById("reports");
        const inputField = document.getElementById("input-field");
        const sendButton = document.getElementById("send-button");
        const followupSection = document.getElementById("followup-section"); // For follow-up questions

        let sessionId = localStorage.getItem("session_id") || generateUUID();
        localStorage.setItem("session_id", sessionId);
        let ws = new WebSocket(`ws://localhost:8000/ws/${sessionId}`);

        ws.onopen = () => console.log("WebSocket connection opened");

        ws.onmessage = (event) => {
            const messageData = JSON.parse(event.data);
            handleMessage(messageData);
        };

        ws.onclose = () => console.log("WebSocket connection closed");

        function generateUUID() {
            return "xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g, function (c) {
                const r = (Math.random() * 16) | 0, v = c == "x" ? r : (r & 0x3) | 0x8;
                return v.toString(16);
            });
        }

        function handleMessage(messageData) {
            const terminal = document.getElementById("terminal");
            let lineClass = "bot-output";
            let icon = '<i class="fas fa-microchip"></i> ';

            if (messageData.type === "thinking") {
                lineClass = "thinking";
                icon = '<i class="fas fa-spinner fa-spin"></i> '; // Spinning icon
            }

            // Display messages in the terminal
            const line = document.createElement("div");
            line.classList.add("line", lineClass);
            line.innerHTML = icon + messageData.content;
            terminal.appendChild(line);
            terminal.scrollTop = terminal.scrollHeight;

            // Handle the final report separately
            if (messageData.type === "final_report") {
                createReportSection('final_report', 'Truth Analysis Report', messageData.content);

                // Show the follow-up section after the report is generated
                followupSection.style.display = "block"; 
            }

            // Handle follow-up responses 
            if (messageData.type === "followup_response") {
                addToFollowupChat(messageData.content, "bot");
            }

            // Handle errors
            if (messageData.type === "error") {
                const errorLine = document.createElement("div");
                errorLine.classList.add("line", "bot-output");
                errorLine.innerHTML = icon + '<span style="color: red;">' + messageData.content + '</span>'; 
                terminal.appendChild(errorLine);
                terminal.scrollTop = terminal.scrollHeight;
            } 
        }

        function sendMessage() {
            const message = inputField.value;
            if (message.trim() !== "") {
                const userLine = document.createElement("div");
                userLine.classList.add("line", "user-input");
                userLine.textContent = "> " + message;
                terminal.appendChild(userLine);
                inputField.value = "";

                ws.send(JSON.stringify({ type: "new_question", content: message }));
            }
        }

        function createReportSection(type, title, content) {
            const sectionId = type + "-section";
            let existingSection = document.getElementById(sectionId);

            if (!existingSection) {
                existingSection = document.createElement("div");
                existingSection.id = sectionId;
                existingSection.classList.add("report-section");
                reports.appendChild(existingSection);

                const sectionHeading = document.createElement("h3");
                sectionHeading.textContent = title;
                existingSection.appendChild(sectionHeading);

                const contentDiv = document.createElement("div");
                contentDiv.classList.add("content");
                contentDiv.innerHTML = '<div class="report-content">' + marked.parse(content) + '</div>'; 
                existingSection.appendChild(contentDiv);

                // Add the timeline after the report content
                if (type === 'final_report') {
                    const timelineDiv = document.createElement("div");
                    timelineDiv.id = "timeline";
                    contentDiv.appendChild(timelineDiv);
                }

                sectionHeading.addEventListener("click", () => {
                    contentDiv.style.display = contentDiv.style.display === "none" ? "block" : "none";
                });
            } else {
                // Update content if the section already exists
                existingSection.querySelector(".content").innerHTML = '<div class="report-content">' + marked.parse(content) + '</div>';
            }
        }

        // ------------- D3.js Timeline Rendering -------------
        function renderTimeline(timelineData) {
            const timelineDiv = d3.select("#timeline");
            timelineDiv.selectAll("*").remove(); // Clear any previous timeline

            // Set margins, width, and height
            const margin = { top: 20, right: 20, bottom: 30, left: 50 },
                width = 960 - margin.left - margin.right,
                height = 200 - margin.top - margin.bottom;

            // Parse the date / time
            const parseDate = d3.timeParse("%Y-%m-%d");
            timelineData.forEach(d => d.date = parseDate(d.date) || new Date()); // Parse or use current date

            // Create the SVG canvas
            const svg = timelineDiv.append("svg")
                .attr("width", width + margin.left + margin.right)
                .attr("height", height + margin.top + margin.bottom)
                .append("g")
                .attr("transform", `translate(${margin.left},${margin.top})`);

            // Create the time scale (adjust range based on timeline size)
            const xScale = d3.scaleTime()
                .domain(d3.extent(timelineData, d => d.date))
                .range([0, width]);

            // Create the timeline line
            svg.append("line")
                .attr("class", "timeline-line")
                .attr("x1", 0)
                .attr("y1", height / 2)
                .attr("x2", width)
                .attr("y2", height / 2);

            // Add event circles
            svg.selectAll("circle")
                .data(timelineData)
                .enter()
                .append("circle")
                .attr("class", "timeline-circle")
                .attr("cx", d => xScale(d.date))
                .attr("cy", height / 2)
                .attr("r", 5)
                .attr("fill", d => {
                    if (d.type === 'claim') return 'green';
                    if (d.type === 'subclaim') return 'blue';
                    if (d.type === 'question') return 'yellow';
                    if (d.type === 'result') return 'orange';
                    if (d.type === 'analysis') return 'red';
                    return 'gray'; // Default color
                })
                // Add tooltips (basic tooltip, you can customize this)
                .on("mouseover", (event, d) => {
                    svg.append("text")
                        .attr("class", "timeline-label")
                        .attr("x", xScale(d.date) + 10)
                        .attr("y", height / 2 - 10)
                        .text(d.title); 
                })
                .on("mouseout", () => svg.select(".timeline-label").remove());

            // Add the X-axis
            svg.append("g")
                .attr("transform", `translate(0,${height})`)
                .call(d3.axisBottom(xScale));
        }

        // ------------- Follow-up Question Handling -------------

        // Create follow-up chat area
        function createFollowupChat() {
            const chatDiv = document.createElement("div");
            chatDiv.id = "followup-chat";
            followupSection.appendChild(chatDiv);

            const inputArea = document.createElement("div");
            inputArea.id = "followup-input-area";

            const inputField = document.createElement("input");
            inputField.type = "text";
            inputField.id = "followup-input-field";
            inputField.placeholder = "Ask a follow-up question...";
            inputArea.appendChild(inputField);

            const sendButton = document.createElement("button");
            sendButton.id = "followup-send-button";
            sendButton.textContent = "Send";
            sendButton.addEventListener("click", sendFollowupQuestion);
            inputArea.appendChild(sendButton);

            followupSection.appendChild(inputArea);
        }

        // Send follow-up question to server
        function sendFollowupQuestion() {
            const inputField = document.getElementById("followup-input-field");
            const message = inputField.value;
            if (message.trim() !== "") {
                addToFollowupChat(message, "user");
                inputField.value = "";
                ws.send(JSON.stringify({ type: "followup", content: message }));
            }
        }

        // Add a message to the follow-up chat area
        function addToFollowupChat(message, sender) {
            const chatDiv = document.getElementById("followup-chat");
            const line = document.createElement("div");
            line.classList.add("line", sender === "user" ? "user-input" : "bot-output");
            line.textContent = (sender === "user" ? "> " : "") + message; 
            chatDiv.appendChild(line);
            chatDiv.scrollTop = chatDiv.scrollHeight;
        }

        // Create the follow-up chat box when the page loads
        window.addEventListener("load", createFollowupChat);

        // -----------------------------------------------------

        sendButton.addEventListener("click", sendMessage);

        inputField.addEventListener("keypress", (event) => {
            if (event.key === "Enter") {
                sendMessage();
            }
        });
    </script>
</body>
</html>